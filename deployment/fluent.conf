<source>
  @type tail
  path "/var/log/containers/*_backend-*.log"
  pos_file /var/log/backend.log.pos
  tag backend
  read_from_head true
  <parse>
    @type regexp
    expression /^(?<time>[^ ]*) (?<stream>stdout|stderr) F (?<log>.*)$/
    # time_key time
    # keep_time_key true
    # time_format %Y-%m-%dT%H:%M:%S.%N%:z
  </parse>
</source>

<filter backend>
  @type record_transformer
  enable_ruby
  <record>
    log ${record["log"].strip}
  </record>
</filter>

<match backend>
  @type rewrite_tag_filter
  <rule>
    key     stream
    pattern /^stdout$/
    tag     "${tag}.stdout"
  </rule>
  <rule>
    key     stream
    pattern /^stderr$/
    tag     "${tag}.stderr"
  </rule>
</match>

<filter backend.stdout>
  @type parser
  key_name log
  <parse>
    @type json
    time_key time
    time_format %Y-%m-%dT%H:%M:%S.%N%:z
    keep_time_key true
  </parse>
</filter>

<filter backend.stderr>
  @type parser
  key_name log
  <parse>
    @type json
    time_key time
    time_format %Y-%m-%dT%H:%M:%S.%N%:z
    keep_time_key true
  </parse>
</filter>

<match backend.stdout>
  @type s3
  format json
  aws_key_id "#{ENV['AWS_KEY_ID']}"
  aws_sec_key "#{ENV['AWS_SEC_KEY']}"
  check_apikey_on_start false
  s3_bucket "#{ENV['S3_BUCKET_NAME']}"
  s3_region ap-northeast-1
  s3_object_key_format "${tag[0]}-log/%{time_slice}/${tag[0]}-%{index}.log.%{file_extension}"
  time_slice_format year=%Y/month=%m/day=%d/hour=%H
  <buffer tag,time>
    @type file
    path "/var/log/fluentd-buffers/s3.buffer"
    timekey 3600
    timekey_wait 10m
    timekey_use_utc false
    chunk_limit_size 1G
    flush_at_shutdown true
  </buffer>
</match>

<match backend.stderr>
  @type s3
  format json
  aws_key_id "#{ENV['AWS_KEY_ID']}"
  aws_sec_key "#{ENV['AWS_SEC_KEY']}"
  check_apikey_on_start false
  s3_bucket "#{ENV['S3_BUCKET_NAME']}"
  s3_region ap-northeast-1
  s3_object_key_format "${tag[0]}-error-log/%{time_slice}/${tag[0]}-error-%{index}.log.%{file_extension}"
  time_slice_format year=%Y/month=%m/day=%d/hour=%H
  <buffer tag,time>
    @type file
    path "/var/log/fluentd-buffers/s3-error.buffer"
    timekey 3600
    timekey_wait 10m
    timekey_use_utc false
    chunk_limit_size 1G
    flush_at_shutdown true
  </buffer>
</match>
